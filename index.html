<script>

var map = L.map('map').setView([17.3850, 78.4867], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var allData = [];
var clusterIndex;
var markersLayer = L.layerGroup().addTo(map);

fetch("hyderabad_electronics.json")
.then(response => response.json())
.then(data => {
    allData = data;
    buildClusters(allData);
    updateMarkers();
});

function buildClusters(data) {

    const geojson = data.map(store => ({
        type: "Feature",
        properties: {
            name: store.name,
            rating: parseFloat(store.rating) || 0,
            reviews: parseInt(store.reviews) || 0
        },
        geometry: {
            type: "Point",
            coordinates: [store.lng, store.lat]
        }
    }));

    clusterIndex = new Supercluster({
        radius: 150,   // increase for larger ~1km style grouping
        maxZoom: 16
    });

    clusterIndex.load(geojson);
}

function updateMarkers() {

    markersLayer.clearLayers();

    var ratingFilter = document.getElementById("ratingFilter").value;
    var reviewFilter = document.getElementById("reviewFilter").value;

    const bounds = map.getBounds();
    const zoom = map.getZoom();

    const bbox = [
        bounds.getWest(),
        bounds.getSouth(),
        bounds.getEast(),
        bounds.getNorth()
    ];

    const clusters = clusterIndex.getClusters(bbox, zoom);

    let count = 0;

    clusters.forEach(cluster => {

        const [lng, lat] = cluster.geometry.coordinates;

        if (cluster.properties.cluster) {

            L.circleMarker([lat, lng], {
                radius: 25,
                fillColor: "#ff7800",
                fillOpacity: 0.6,
                color: "#000",
                weight: 1
            })
            .bindPopup("Cluster: " + cluster.properties.point_count + " stores")
            .addTo(markersLayer);

        } else {

            const store = cluster.properties;

            if (!ratingPass(store.rating, ratingFilter)) return;
            if (!reviewPass(store.reviews, reviewFilter)) return;

            L.marker([lat, lng])
                .bindPopup(
                    "<b>" + store.name + "</b><br>" +
                    "Rating: " + store.rating + "<br>" +
                    "Reviews: " + store.reviews
                )
                .addTo(markersLayer);

            count++;
        }
    });

    document.getElementById("resultCount").innerText =
        "Showing: " + count + " stores";
}

function ratingPass(rating, filter) {
    if (filter === "all") return true;

    var parts = filter.split("-");
    var min = parseFloat(parts[0]);
    var max = parseFloat(parts[1]);

    return rating > min && rating <= max;
}

function reviewPass(reviews, filter) {
    if (filter === "all") return true;

    if (filter === "5000+") return reviews > 5000;

    var parts = filter.split("-");
    var min = parseInt(parts[0]);
    var max = parseInt(parts[1]);

    return reviews > min && reviews <= max;
}

map.on("moveend", updateMarkers);

</script>
