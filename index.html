<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Hyderabad Electronics Interactive Map</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height: 90vh; }
.controls {
    padding: 10px;
    background: white;
}
</style>
</head>

<body>

<div class="controls">
    Rating:
    <select id="ratingFilter">
        <option value="all">All</option>
        <option value="0-1">0–1</option>
        <option value="1-2">1–2</option>
        <option value="2-3">2–3</option>
        <option value="3-4">3–4</option>
        <option value="4-5">4–5</option>
    </select>

    Reviews:
    <select id="reviewFilter">
        <option value="all">All</option>
        <option value="0-10">0–10</option>
        <option value="10-100">10–100</option>
        <option value="100-500">100–500</option>
        <option value="500-1000">500–1000</option>
        <option value="1000-5000">1000–5000</option>
        <option value="5000+">5000+</option>
    </select>

    <button onclick="updateMarkers()">GO</button>

    <span id="resultCount" style="margin-left:15px;font-weight:bold;"></span>
</div>

<div id="map"></div>

<!-- 1️⃣ Load Leaflet FIRST -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- 2️⃣ Load Supercluster -->
<script src="https://unpkg.com/supercluster@7.1.4/dist/supercluster.min.js"></script>

<!-- 3️⃣ Your Custom Script -->
<script>

// ---------------- MAP INIT ----------------
var map = L.map('map').setView([17.3850, 78.4867], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// ---------------- GLOBAL VARIABLES ----------------
var allData = [];
var clusterIndex;
var markersLayer = L.layerGroup().addTo(map);

// ---------------- LOAD DATA ----------------
fetch("hyderabad_electronics.json")
.then(response => response.json())
.then(data => {
    allData = data;
    buildClusters(allData);
    updateMarkers();
})
.catch(error => {
    console.error("Error loading JSON:", error);
});

// ---------------- BUILD CLUSTERS ----------------
function buildClusters(data) {

    const geojson = data.map(store => ({
        type: "Feature",
        properties: {
            name: store.name,
            rating: parseFloat(store.rating) || 0,
            reviews: parseInt(store.reviews) || 0
        },
        geometry: {
            type: "Point",
            coordinates: [store.lng, store.lat] // GeoJSON = [lng, lat]
        }
    }));

    clusterIndex = new Supercluster({
        radius: 150,   // Increase for larger grouping
        maxZoom: 16
    });

    clusterIndex.load(geojson);
}

// ---------------- UPDATE MARKERS ----------------
function updateMarkers() {

    if (!clusterIndex) return;

    markersLayer.clearLayers();

    var ratingFilter = document.getElementById("ratingFilter").value;
    var reviewFilter = document.getElementById("reviewFilter").value;

    const bounds = map.getBounds();
    const zoom = map.getZoom();

    const bbox = [
        bounds.getWest(),
        bounds.getSouth(),
        bounds.getEast(),
        bounds.getNorth()
    ];

    const clusters = clusterIndex.getClusters(bbox, zoom);

    let count = 0;

    clusters.forEach(cluster => {

        const [lng, lat] = cluster.geometry.coordinates;

        if (cluster.properties.cluster) {

            L.circleMarker([lat, lng], {
                radius: 25,
                fillColor: "#ff7800",
                fillOpacity: 0.6,
                color: "#000",
                weight: 1
            })
            .bindPopup("Cluster: " + cluster.properties.point_count + " stores")
            .addTo(markersLayer);

        } else {

            const store = cluster.properties;

            if (!ratingPass(store.rating, ratingFilter)) return;
            if (!reviewPass(store.reviews, reviewFilter)) return;

            L.marker([lat, lng])
                .bindPopup(
                    "<b>" + store.name + "</b><br>" +
                    "Rating: " + store.rating + "<br>" +
                    "Reviews: " + store.reviews
                )
                .addTo(markersLayer);

            count++;
        }
    });

    document.getElementById("resultCount").innerText =
        "Showing: " + count + " stores";
}

// ---------------- FILTER FUNCTIONS ----------------
function ratingPass(rating, filter) {
    if (filter === "all") return true;

    var parts = filter.split("-");
    var min = parseFloat(parts[0]);
    var max = parseFloat(parts[1]);

    return rating > min && rating <= max;
}

function reviewPass(reviews, filter) {
    if (filter === "all") return true;

    if (filter === "5000+") return reviews > 5000;

    var parts = filter.split("-");
    var min = parseInt(parts[0]);
    var max = parseInt(parts[1]);

    return reviews > min && reviews <= max;
}

// Auto-update on zoom/pan
map.on("moveend", updateMarkers);

</script>

</body>
</html>
