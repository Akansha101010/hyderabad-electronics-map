<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Hyderabad Electronics Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height: 88vh; }

.controls {
    padding: 12px;
    background: white;
    font-size:14px;
}

.legend {
    margin-top:10px;
    font-size:13px;
    line-height: 1.6;
}

.legend span {
    display:inline-block;
    width:14px;
    height:14px;
    margin-right:6px;
}
</style>
</head>

<body>

<div class="controls">
    <b>Filters</b><br><br>

    Rating:
    <select id="ratingFilter">
        <option value="all">All</option>
        <option value="0-1">0â€“1</option>
        <option value="1-2">1â€“2</option>
        <option value="2-3">2â€“3</option>
        <option value="3-4">3â€“4</option>
        <option value="4-5">4â€“5</option>
    </select>

    Reviews:
    <select id="reviewFilter">
        <option value="all">All</option>
        <option value="0-10">0â€“10</option>
        <option value="10-100">10â€“100</option>
        <option value="100-500">100â€“500</option>
        <option value="500-1000">500â€“1000</option>
        <option value="1000-5000">1000â€“5000</option>
        <option value="5000+">5000+</option>
    </select>

    <button onclick="updateMarkers()">GO</button>

    <span id="resultCount" style="margin-left:15px;font-weight:bold;"></span>

    <div class="legend">
        <b>Cluster Legend</b><br>
        <span style="background:rgba(255,204,0,0.8)"></span>1â€“100 (Yellow)<br>
        <span style="background:rgba(0,150,0,0.8)"></span>100â€“500 (Green)<br>
        <span style="background:rgba(255,0,150,0.8)"></span>500â€“1000 (Pink)<br>
        <span style="background:rgba(255,120,0,0.9)"></span>1000+ (Orange)
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/supercluster@7.1.4/dist/supercluster.min.js"></script>

<script>

// ---------------- MAP INIT ----------------
var map = L.map('map').setView([17.3850, 78.4867], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// ---------------- GLOBALS ----------------
var allData = [];
var clusterIndex;
var markersLayer = L.layerGroup().addTo(map);

// ---------------- LOAD DATA ----------------
fetch("hyderabad_electronics.json")
.then(response => response.json())
.then(data => {
    allData = data;
    applyFiltersAndBuild();
});

// ---------------- MAIN FILTER PIPELINE ----------------
function applyFiltersAndBuild() {

    var ratingFilter = document.getElementById("ratingFilter").value;
    var reviewFilter = document.getElementById("reviewFilter").value;

    // ðŸ”¥ FILTER FIRST
    const filteredData = allData.filter(store => {
        return ratingPass(store.rating, ratingFilter) &&
               reviewPass(store.reviews, reviewFilter);
    });

    document.getElementById("resultCount").innerText =
        "Showing: " + filteredData.length + " stores";

    buildClusters(filteredData);
    updateMarkers();
}

// ---------------- BUILD CLUSTERS ----------------
function buildClusters(data) {

    const geojson = data.map(store => ({
        type: "Feature",
        properties: {
            name: store.name,
            rating: parseFloat(store.rating) || 0,
            reviews: parseInt(store.reviews) || 0
        },
        geometry: {
            type: "Point",
            coordinates: [store.lng, store.lat]
        }
    }));

    clusterIndex = new Supercluster({
        radius: 150,
        maxZoom: 16
    });

    clusterIndex.load(geojson);
}

// ---------------- UPDATE MARKERS ----------------
function updateMarkers() {

    if (!clusterIndex) return;

    markersLayer.clearLayers();

    const bounds = map.getBounds();
    const zoom = map.getZoom();

    const bbox = [
        bounds.getWest(),
        bounds.getSouth(),
        bounds.getEast(),
        bounds.getNorth()
    ];

    const clusters = clusterIndex.getClusters(bbox, zoom);

    clusters.forEach(cluster => {

        const [lng, lat] = cluster.geometry.coordinates;

        if (cluster.properties.cluster) {

            let count = cluster.properties.point_count;
            let color = getClusterColor(count);

            L.circleMarker([lat, lng], {
                radius: 18 + Math.log(count) * 4,
                fillColor: color,
                fillOpacity: 0.85,
                color: "#333",
                weight: 1
            })
            .bindPopup("Cluster: " + count + " stores")
            .addTo(markersLayer);

        } else {

            const store = cluster.properties;

            L.marker([lat, lng])
                .bindPopup(
                    "<b>" + store.name + "</b><br>" +
                    "Rating: " + store.rating + "<br>" +
                    "Reviews: " + store.reviews
                )
                .addTo(markersLayer);
        }
    });
}

// ---------------- FILTER FUNCTIONS ----------------
function ratingPass(rating, filter) {
    if (filter === "all") return true;
    var parts = filter.split("-");
    return parseFloat(rating) > parseFloat(parts[0]) &&
           parseFloat(rating) <= parseFloat(parts[1]);
}

function reviewPass(reviews, filter) {
    if (filter === "all") return true;
    if (filter === "5000+") return reviews > 5000;
    var parts = filter.split("-");
    return parseInt(reviews) > parseInt(parts[0]) &&
           parseInt(reviews) <= parseInt(parts[1]);
}

// ---------------- CLUSTER COLOR ----------------
function getClusterColor(count) {

    if (count <= 100) {
        return "rgba(255,204,0,0.8)";
    }

    if (count <= 500) {
        return "rgba(0,150,0,0.8)";
    }

    if (count <= 1000) {
        return "rgba(255,0,150,0.8)";
    }

    return "rgba(255,120,0,0.9)";
}

// Re-cluster when GO clicked
document.querySelector("button").addEventListener("click", applyFiltersAndBuild);

// Auto-update on pan/zoom
map.on("moveend", updateMarkers);

</script>

</body>
</html>
